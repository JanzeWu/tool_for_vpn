# 消息系统
消息系统允许软件、应用相互连接和拓展。这些应用可以相互链接起来组成一个更大的应用，或者将用户设备和数据进行连接。消息系统通过将消息的发送和接收的分离来实现应用程序的异步和解偶。

## RabbitMQ
RabbitMQ是一个消息代理，一个消息系统的媒介。它可以为应用提供一个通用的消息发送和接收平台，并且保证消息在传输过程中的安全性。

### RabbitMQ 工作原理
RabbitMQ 使用AMQP协议（高级消息队列协议）,AMQP是一个网络协议，它支持符合要求的客户端应用和消息中间件代理（messaging middleware broker）之间进行通信。

消息代理从发布者接收消息，并根据既定的路由规则把接收到的消息发送给处理消息的消费者。

AMQP的工作过程：消息被发布者发送给交换机，交换机将接收到的消息根据路由规则分发给帮顶的队列。最后AMQP代理将消息投递给订阅了此队列的消费者，或者消费者按照需求自行获取。

```mermaid

```

从安全角度考虑，网络是不可靠的，接收消息的应用也有可能在处理消息的时候失败。AMQP模块包含了一个消息确认（message acknowledgements）的概念：当一个消息从队列中投递给消费者后，消费者会通知一下消息代理，这个可以是自动的也可以由处理消息的应用的开发者执行。当“消息确认”被启用后，消息代理不会完全将消息从队列中删除，直到它收到来自消费者的确认回执。

### 交换机和交换机类型

交换机是用来发送消息的AMQP实体。交换机拿到一个消息之后将它路由给一个或者两个队列。它使用哪种路由算法是由交换机类型和被绑定的规则所决定的。AMQP 的代理提供了四种交换机

| Name（交换机类型）          | Default pre-declared names(预声明的默认名称) |
| --------------------------- | :------------------------------------------- |
| Direct exchange(直连交换机) | (Empty string) and amq.direct                |
| Fanout exchange(扇形交换机) | amq.fanout                                   |
| Topic exchange(主题交换机)  | amq.topic                                    |
|                             |                                              |

交换机可以有两种状态：持久（durable）、暂存（transient）。持久化的交换机会在消息代理重启后依旧存在，而暂存的交换机则不会（需要在代理再次上线后重新被声明）。

### 默认交换机

默认交换机实际上是一个由消息代理预先声明的没有名字的直连交换机。每个新建队列都会自动绑定到默认交换机上，绑定的路由键名称与队列名称相同。

###  直连交换机

根据消息携带的路由键将消息投递给对应的队列。

1. 消费者将一个队列绑定到某个交换机上，同时赋予该绑定一个路由键；
2. 当发布者将一个携带着路由键为R的消息被发送给直连交换机时，交换机会把它路由给绑定值同样为R的队列。



### 扇形交换机

将消息路由给绑定到它身上的所有队列，而不理会绑定的路由键。



### 主题交换机

通过对消息的路由键和队列到交换机的绑定模式之间的匹配，将消息路由给一个或多个队列。



### 头交换机

头交换机使用多个消息属性来代替路由键建立路由规则，通过判断消息头的值能否与指定的绑定相匹配来确立路由规则。



### 队列及持久化

存储着即将被消费掉的消息。持久化队列会被存储在磁盘上，当消息代理重启的时候，它依旧存在。若消息代理挂掉，持久化队列会被重新声明，只有持久化的消息才能被重新恢复。



### 绑定

交换机将消息路由给队列所需遵循的规则。

### 连接和通道

AMQP 连接通常是长连接，使用TCP提供可靠投递。通道是共享一个TCP连接的多个轻量化的连接。在涉及多线程/进程的应用中，为每个线程/进程开启一个通道，并且这些通道是线程/进程私有的。





